<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Teste 1</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="styles 2.css">
    <style>
        /* Estilos adicionais para as mensagens de status */
        .mensagem-sucesso {
            color: green;
            font-weight: bold;
            margin-top: 10px;
        }
        .mensagem-erro {
            color: red;
            font-weight: bold;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="header-content">
            <div class="header-left">
                <div class="logo-container">
                    <i class="fas fa-database"></i>
                </div>
                <div class="header-text">
                    <h1>Sistema Plastick</h1>
                    <p>Banco de dados</p>
                </div>
            </div>
        </div>
    </header>

    <nav class="navigation">
        <div class="nav-container">
            <a href="index.html" class="nav-tab"><i class="fas fa-chart-line"></i> Dados</a>
            <a href="Contabilidade.html" class="nav-tab"><i class="fas fa-calculator"></i> Contabilidade</a>
            <a href="Coletar de dados.html" class="nav-tab"><i class="fas fa-file-import"></i> Coletar de dados</a>
            <a href="Coletar da contabilidade.html" class="nav-tab active"><i class="fas fa-file-invoice"></i> Coletar da Contabilidade</a>
        </div>
    </nav>

    <main class="main-content">
        <section id="coletar-contabilidade" class="content-section">
            <h2 class="section-title">Coletar Dados de Contabilidade</h2>
            <form id="formColetarContabilidade" class="form-filter">
                <div class="form-group">
                    <label for="impostosContabilidade">Impostos:</label>
                    <input type="text" class="money" id="impostosContabilidade" name="impostos" required placeholder="Ex: 1.500,00" />
                </div>
                <div class="form-group">
                    <label for="materiaPrimaContabilidade">Despesas com matéria-prima:</label>
                    <input type="text" class="money" id="materiaPrimaContabilidade" name="materiaPrima" required placeholder="Ex: 10.000,00" />
                </div>
                <div class="form-group">
                    <label for="apuradoMesContabilidade">Apurado do Mês (Receita Líquida):</label>
                    <input type="text" class="money" id="apuradoMesContabilidade" name="apuradoMes" required placeholder="Ex: 45.000,00" />
                </div>
                <div class="form-group">
                    <label for="lucroMesContabilidade">Lucro do mês:</label>
                    <input type="text" class="money" id="lucroMesContabilidade" name="lucroMes" required placeholder="Ex: 8.000,00" />
                </div>
                <div class="form-group">
                    <label for="salariosContabilidade">Despesa dos salários dos funcionários:</label>
                    <input type="text" class="money" id="salariosContabilidade" name="salarios" required placeholder="Ex: 12.000,00" />
                </div>
                <div class="form-group">
                    <label for="totalReceitasContabilidade">Total de Receitas:</label>
                    <input type="text" class="money" id="totalReceitasContabilidade" name="totalReceitas" required placeholder="Ex: 60.000,00" />
                </div>
                <div class="form-group">
                    <label for="dataContabilidadeMes">Data do Mês (Referência):</label>
                    <input type="date" id="dataContabilidadeMes" name="dataMesContabilidade" required />
                </div>
                <button id="enviarContabilidadeBtn" type="submit">
                    <i class="fas fa-file-invoice-dollar"></i> Enviar Dados Contábeis
                </button>
            </form>
            <div id="mensagemStatusContabilidade"></div>
        </section>
    </main>

    <script>
    // Máscara para formatar moeda brasileira (R$) no input enquanto digita
    document.querySelectorAll('.money').forEach(input => {
        input.addEventListener('input', () => {
            let valor = input.value.replace(/\D/g, '');
            if (valor.length === 0) {
                input.value = '';
                return;
            }

            valor = (parseInt(valor, 10) / 100).toFixed(2);
            valor = valor.replace('.', ',');
            valor = valor.replace(/\B(?=(\d{3})+(?!\d))/g, '.');
            input.value = valor;
        });
    });

    // Função para converter formato brasileiro "1.234,56" para número 1234.56
    function formatToNumber(valorStr) {
        if (!valorStr) return 0;
        // Remove todos os pontos e substitui vírgula por ponto
        let cleanedString = valorStr.replace(/\./g, '').replace(',', '.');
        // Converte para float
        return parseFloat(cleanedString) || 0;
    }

    document.getElementById('formColetarContabilidade').addEventListener('submit', async (e) => {
        e.preventDefault();

        // Validação da data
        const dataInput = document.getElementById('dataContabilidadeMes').value;
        if (!dataInput) {
            alert('Por favor, selecione uma data válida');
            return;
        }

        // Coleta os valores do formulário e os formata
        const dados = {
            impostos: formatToNumber(document.getElementById('impostosContabilidade').value),
            materia_prima: formatToNumber(document.getElementById('materiaPrimaContabilidade').value),
            apurado_mes: formatToNumber(document.getElementById('apuradoMesContabilidade').value),
            lucro_mes: formatToNumber(document.getElementById('lucroMesContabilidade').value),
            salarios: formatToNumber(document.getElementById('salariosContabilidade').value),
            total_receitas: formatToNumber(document.getElementById('totalReceitasContabilidade').value),
            data_mes: dataInput // Formato yyyy-MM-dd (padrão do input date)
        };
        
        // Log para verificar os dados antes do envio
        console.log('Dados formatados para envio:', dados);

        const mensagemStatus = document.getElementById('mensagemStatusContabilidade');
        mensagemStatus.textContent = 'Enviando dados...';
        mensagemStatus.className = '';

        try {
            const resp = await fetch('http://localhost:3001/enviar-contabilidade', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(dados)
            });

            const texto = await resp.text();

            if (resp.ok) {
                mensagemStatus.textContent = '✅ Dados de contabilidade inseridos com sucesso!';
                mensagemStatus.className = 'mensagem-sucesso';
                document.getElementById('formColetarContabilidade').reset();
                
                // Recarrega dados após inserção (se necessário)
                // carregarDadosContabilidade(); 
            } else {
                mensagemStatus.textContent = `❌ Erro ao enviar dados: ${texto}`;
                mensagemStatus.className = 'mensagem-erro';
                console.error('Erro na resposta do servidor:', resp.status, texto);
            }
        } catch (error) {
            mensagemStatus.textContent = '❌ Erro na requisição. Verifique se o servidor está rodando.';
            mensagemStatus.className = 'mensagem-erro';
            console.error('Erro na requisição:', error);
            
            // Detalhes adicionais do erro
            if (error instanceof TypeError) {
                console.error('Possível erro de CORS ou rede:', error.message);
            }
        }
    });

    // Função opcional para carregar dados após inserção
    async function carregarDadosContabilidade() {
        try {
            const response = await fetch('http://localhost:3001/filtrar-contabilidade', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ mes: new Date().getMonth() + 1, ano: new Date().getFullYear() })
            });
            
            const dados = await response.json();
            console.log('Dados recarregados:', dados);
            // Atualizar interface com novos dados...
        } catch (error) {
            console.error('Erro ao recarregar dados:', error);
        }
    }
</script>
</body>
</html>